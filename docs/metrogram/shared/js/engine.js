/*
	engine.js
	copyright 2014 nulldesign.jp ALL RIGHTS RESERVED.
*/
(function(){window.onload=function(){function q(){x=easeInOutSine(T,0,8,30);document.getElementById("siteBody").style.webkitFilter="blur("+x+"px)";if(T>=30){clearInterval(S)}T++}function R(){$.ajax({url:"./shared/xml/stationlist.xml",type:"GET",dataType:"XML",success:function(e){var t={};$(e).find("line").each(function(){var e=$(this).attr("id");var n=$(this).attr("color");var r=[];$(this).find("item").each(function(){var i=parseFloat($(this).find("location longitude").eq(0).text());var s=parseFloat($(this).find("location latitude").eq(0).text());if(t[$(this).attr("id")]){i=t[$(this).attr("id")].x;s=t[$(this).attr("id")].y}var o=$(this).find("connection").eq(0).text();if(o!=""){var u=$(this).find("connection").eq(0).text().split(",");var a=u.length;for(var f=0;f<a;f++){if(t[u[f]]==undefined){t[u[f]]={x:i,y:s}}}}var l=$(this).find("name").eq(0).text();var c=$(this).find("english").eq(0).text();var h={name:l,english:c,x:i,y:s};r.push(h);if(e!="yamanote"&&e!="oedo"){I.push({x:i,y:s,name:l,english:c,color:n})}});var i={};i.id=$(this).attr("id");i.color=$(this).attr("color");i.name=$(this).attr("name");i.rlist=r;i.dlist=[];i.dlist[0]=SplineCurve(r,F);i.dlist[1]=SplineCurve(r,F).reverse();i.schdule=_schdule[$(this).attr("id")];i.pointerlist=[];i.pointerlist[0]=[];i.pointerlist[1]=[];var s=i.schdule.length;for(var o=0;o<s;o++){var u=i.schdule[o].length;for(var a=0;a<u;a++){i.pointerlist[o][a]=0;var f=i.schdule[0][o].length;for(var c=0;c<f;c++){if(i.schdule[o][a][c]!="-"){var h=i.schdule[o][a][c].split(":");var p=parseInt(h[0]);var d=parseInt(h[1]);var v=p*60+d;i.schdule[o][a][c]=v}}}}l[i.id]=i});U();z();X();V();$("#siteBody").addClass("a0");setTimeout(function(){$("#siteBody").removeClass("a0").addClass("fadeIn");$("#timer").addClass("timeIn")},500);setTimeout(function(){$(n).removeClass().addClass("fadeIn");$(i).removeClass().addClass("fadeIn")},2e3);setTimeout(function(){$(a).removeClass().addClass("fadeIn")},2600);setTimeout(function(){$(o).removeClass().addClass("fadeIn")},3200)},error:function(e){console.log(e)}})}function U(){$(window).on("resize",Y);_=$(window).width();D=$(window).height();if(B){_*=2;D*=2}Z(_,D)}function z(){W();E=setInterval(Q,1e3/p)}function W(){clearInterval(E)}function X(){setTimeout(function(){setInterval(function(){var e=floor(Math.random()*I.length);P=I[e].x;H=I[e].y;h=floor(Math.random()*8)*3e3+12e3;m=h/12e3;if(h<12e3){P=139.752799;H=35.685175;C.text("");k.text("");L.text("")}else{A.setText(I[e].name);O.setText(I[e].english);M.setText($("#timer").text());C.text("");k.text("");L.text("");A.start();O.start();M.start()}et()},1e3*8)},4200)}function V(){$("#btnAbout a").on("click",function(){if(!$("#aboutWrapper").hasClass("show")){$("#aboutWrapper").addClass("show");$("#about").addClass("fadeIn2About");T=0;clearInterval(S);S=setInterval(q,1e3/p)}else{$("#aboutWrapper").removeClass("show");clearInterval(S);document.getElementById("siteBody").style.webkitFilter="blur(0px)"}}).attr("href","javascript:void(0);");$("#aboutWrapper").on("click",function(e){$(this).removeClass();clearInterval(S);document.getElementById("siteBody").style.webkitFilter="blur(0px)";return false});$(window).on("scroll",function(e){e.preventDefault()})}function J(){n=document.createElement("canvas");r=n.getContext("2d");$("#siteBody").append(n);o=document.createElement("canvas");u=o.getContext("2d");$("#siteBody").append(o);i=document.createElement("canvas");s=i.getContext("2d");$("#siteBody").append(i);a=document.createElement("canvas");f=a.getContext("2d");$("#siteBody").append(a);$(n).addClass("a0");$(i).addClass("a0");$(o).addClass("a0");$(a).addClass("a0")}function Q(){g++;b=floor(g*v);w=K==b?true:false;K=b;var e=floor(b/60)%24+100;var t=b%60+100;var n=floor(g*v*60)%60+100;e=String(""+e).substr(1,2);t=String(""+t).substr(1,2);n=String(""+n).substr(1,2);document.getElementById("timer").innerHTML=e+":"+t+":"+n;if(!w){G()}tt();if(g>y+1440/v){it()}$("#siteBody").css("backgroundPosition","-100px "+floor(-g*3*m)+"px")}function G(){for(var e in l){var t=l[e].schdule;var n=l[e].pointerlist;var r=t.length;for(var i=0;i<r;i++){var s=t[i].length;for(var o=0;o<s-1;o++){var u=nt(o,n[i][o],i,l[e].id);var a=rt(o,u,i,l[e].id);if(b==t[i][o][u]){var f=t[i][o][u];var h=t[i][o][a];var p=i;var d={id:l[e].id,color:l[e].color,startIndex:u,endIndex:a,start:f,end:h,dir:p};n[i][o]=a;if(t[i][o].length>n[i][o]){c.push(d)}}}}}}function Y(e){_=$(window).width();D=$(window).height();if(B){_*=2;D*=2}Z(_,D)}function Z(e,t){n.width=e;n.height=t;i.width=e;i.height=t;o.width=e;o.height=t;a.width=e;a.height=t;et()}function et(){var e=_*.5;var t=D*.5;var n=[];r.beginPath();r.clearRect(0,0,_,D);u.beginPath();u.clearRect(0,0,_,D);f.beginPath();f.clearRect(0,0,_,D);f.fillStyle="rgba(0,0,0,0.6)";for(var i in l){var s=l[i].dlist;var o=l[i].rlist;var a=s[0].length;var c=true;r.beginPath();r.strokeStyle="rgba(0,0,0,0.1)";r.lineWidth=3*m;if(l[i].id=="yamanote"||l[i].id=="oedo"){r.lineWidth=1*m}r.moveTo((s[0][0].x-P)*h+e,-(s[0][0].y-H)*h+t);for(var p=1;p<a;p++){r.lineTo((s[0][p].x-P)*h+e,-(s[0][p].y-H)*h+t)}r.stroke();u.beginPath();u.strokeStyle="rgba(0,0,0,0.6)";u.lineWidth=4*m;u.fillStyle="#FFFFFF";var a=o.length;var d=2.5*m;if(l[i].id=="yamanote"||l[i].id=="oedo"){u.strokeStyle="rgba(0,0,0,0.2)";d=1.5*m}for(var p=0;p<a;p++){u.moveTo((o[p].x-P)*h+d+e,-(o[p].y-H)*h+t);u.arc((o[p].x-P)*h+e,-(o[p].y-H)*h+t,d,0,Math.PI*2);f.font=Math.floor(N*m)+"px Arial";var v=round((o[p].x-P)*h+e+8*m);var g=round(-(o[p].y-H)*h+t+5);var y=n.length;var b=true;while(y){y--;var w=n[y];if(w.x==v&&w.y==g){b=false;break}}if(l[i].id=="yamanote"||l[i].id=="oedo"){b=false}if(b){n.push({x:v,y:g});f.fillText(o[p].name,v,g)}}u.stroke();u.fill();f.fill()}}function tt(){s.beginPath();s.clearRect(0,0,_,D);var e=_*.5;var t=D*.5;var n=c.length;while(n){n--;var r=c[n];var i=r.id;var o=l[i].dlist;var u=r.end-r.start;var a=r.startIndex;var f=r.endIndex;var p=r.dir;var d=o[p].slice(a*F,f*F+1);u/=v;_startFrame=r.start/v;if(b>=r.end){c.splice(n,1);continue}var y=floor(easeInOutSine(g-_startFrame,0,d.length,u));var w=3;var E=1;if(f-a>1){w=6;E=2}w*=m;var S=l[i].color;s.beginPath();s.fillStyle="#"+S;var x=d[y].x;var T=d[y].y;s.moveTo((x-P)*h+e,-(T-H)*h+t);s.arc((x-P)*h+e,-(T-H)*h+t,w,0,6.3);s.fill()}n=c.length;while(n){n--;var r=c[n];var i=r.id;var o=l[i].dlist;var u=r.end-r.start;var a=r.startIndex;var f=r.endIndex;var p=r.dir;var d=o[p].slice(a*F,f*F+1);u/=v;_startFrame=r.start/v;if(b>=r.end){c.splice(n,1);continue}var y=floor(easeInOutSine(g-_startFrame,0,d.length,u));var S=parseInt(l[i].color,16);var w=S>>16&255;var N=S>>8&255;var C=S&255;s.beginPath();s.fillStyle="rgba("+w+","+N+","+C+",0.16)";var k=12*m;var x=d[y].x;var T=d[y].y;s.moveTo((x-P)*h+e,-(T-H)*h+t);s.arc((x-P)*h+e,-(T-H)*h+t,k,0,6.3);s.fill()}}function nt(e,t,n,r){var i=l[r].schdule;if(i[n][e].length<t){return i[n][e].length-1}if(i[n][e][t]=="-"){return nt(e,t+1,n,r)}return t}function rt(e,t,n,r){var i=l[r].schdule;var s=t+1;if(i[n][e].length<s){return i[n][e].length-1}if(i[n][e][s]=="-"){return rt(e,s,n,r)}return s}function it(){for(var e in l){var t=l[e].pointerlist[0].length;for(var n=0;n<t;n++){l[e].pointerlist[0][n]=0}var t=l[e].pointerlist[1].length;for(var n=0;n<t;n++){l[e].pointerlist[1][n]=0}}c=[];g=(parseInt(d.split(":")[0])*60+parseInt(d.split(":")[1]))/v;b=0;w=false}var e,t;var n,r;var i,s;var o,u;var a,f;var l={};var c=[];var h=12e3;var p=60;var d="04:55";var v=.02;var m=h/12e3;var g=(parseInt(d.split(":")[0])*60+parseInt(d.split(":")[1]))/v;var y=g;var b=0;var w=false;var E;var S;var x=0;var T=0;var N=10;var C=$("#sname");var k=$("#sename");var L=$("#stime");var A=new randomtypo(C,"",300);var O=new randomtypo(k,"",400);var M=new randomtypo(L,"",500);var _=$(window).width();var D=$(window).height();var P=139.752799;var H=35.685175;var B=false;var j=getUA();var B=false;if(j.iphone||j.android){$("body").addClass("sp");B=true}var F=60;var I=[];var K=0;J();R()}})()
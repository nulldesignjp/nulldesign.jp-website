
var card=function(_imgURL){this.view;this.core;this.img;this.x;this.y;this._rotation;this._isPress;this._R;this._r;this._mouse;;this._preMouse;this._preCard;this._vector;this._M;this._w;this._aw;this._width;this._height;this._friction;this.clickTime;this.isSmartPhone;this.intervalKey;this.init.apply(this,arguments);}card.mouse={x:0,y:0};card.zIndex=0;card.prototype={init:function(_imgURL){var _d=document;var $_d=$(_d);var _=this;_.view=_d.createElement('div');_.view.className='card';_.core=_d.createElement('div');_.core.className='cardCore';_.img=new Image();_.view.appendChild(_.core);_.core.appendChild(_.img);_.x=0;_.y=0;_.rotation=0;_.x=Math.floor($_d.width()*Math.random());_.y=Math.floor($_d.height()*Math.random());_._rotation=Math.random()*Math.PI;_._isPress=false;_._preMouse={x:0,y:0};_._preCard={x:0,y:0};_._vector={x:0,y:0};_._w=0;_._aw=0;_._friction=.9600;_.view.style.cursor='pointer';_._preMouse.x=0;_._preMouse.y=0;_._preCard.x=_.x;_._preCard.y=_.y;_._vector.x=Math.random()*24-12;_._vector.y=Math.random()*24-12;_._w=Math.random()*Math.PI*.06-Math.PI*.03;_.view.style.visibility='hidden';_.clickTime=0;$(_.img).load(function(e){$(this).css({'top':-parseInt($(this).height()*.5),'left':-parseInt($(this).width()*.5)});_._width=$(this).width();_._height=$(this).height();_._R=Math.sqrt(_._width*_._width+_._height*_._height);_._M=_._width*_._height*.0002;var _ua=navigator.userAgent;if(_ua.indexOf('iPhone')!=-1||_ua.indexOf('iPad')!=-1||_ua.indexOf('Android')!=-1){_.isSmartPhone=true;}if(_.isSmartPhone){$_d.bind('touchmove',function(e){card.mouse.x=e.originalEvent.touches[0].pageX;card.mouse.y=e.originalEvent.touches[0].pageY;e.preventDefault();});$(_.view).bind('touchstart',function(e){card.mouse.x=e.originalEvent.touches[0].pageX;card.mouse.y=e.originalEvent.touches[0].pageY;_._onDown(e,_);});$_d.bind('touchend',function(e){_._onUp(e,_);});}else{$_d.mousemove(function(e){card.mouse.x=e.pageX;card.mouse.y=e.pageY;});$(_.view).mousedown(function(e){_._onDown(e,_);});$_d.mouseup(function(e){_._onUp(e,_);});}_._update();_.view.style.visibility='visible';_.intervalKey=setInterval(function(e){_._loop();},1000/30);});_.img.src=_imgURL;},_onDown:function(e,_path){var _=this;var _v=$(_.view);var _dx=_v.offset().left-card.mouse.x;var _dy=_v.offset().top-card.mouse.y;_._r=Math.sqrt(_dx*_dx+_dy*_dy);var _curMouse={x:card.mouse.x,y:card.mouse.y};_.x=card.mouse.x;_.y=card.mouse.y;var _prop={};_prop.top=_.y;_prop.left=_.x;_prop.zIndex=100;_v.css(_prop);var _sin=Math.sin(-_._rotation);var _cos=Math.cos(-_._rotation);var __dx=_cos*_dx-_sin*_dy;var __dy=_sin*_dx+_cos*_dy;$(_.core).css({'top':__dy,'left':__dx});_._isPress=true;e.preventDefault();var _current=new Date().getTime();if(_current-_.clickTime<400&&_.clickTime>0){_._doubleClick();}_.clickTime=_current;$(_.img).addClass('shadow');_v.css({'zIndex':card.zIndex});card.zIndex++;},_onUp:function(e,_path){var _=this;var _cueCard=$(_.core).offset();_.x=_cueCard.left;_.y=_cueCard.top;var _prop={};_prop.top=_.y;_prop.left=_.x;$(_.view).css(_prop);$(_.core).css({'top':0,'left':0});_._aw=0;_._isPress=false;$(_.img).removeClass('shadow');},_loop:function(){var hPI=Math.PI*.5;var _=this;var _c=$(_.core);var _v=$(_.view);var _curMouse={x:card.mouse.x,y:card.mouse.y};if(_._isPress){var _view=_v.offset();var _core=_c.offset();var _dx=-parseInt(_c.css('left'));var _dy=-parseInt(_c.css('top'));var _d=_._r;var _rad=Math.atan2(_dy,_dx);var _angle=_._rotation;var _mouseVector={x:_curMouse.x-_._preMouse.x,y:_curMouse.y-_._preMouse.y};var _sin=Math.sin(-_angle);var _cos=Math.cos(-_angle);var _mvx=_mouseVector.x*_cos-_mouseVector.y*_sin;var _mvy=_mouseVector.x*_sin+_mouseVector.y*_cos;_sin=Math.sin(hPI-_rad);_cos=Math.cos(hPI-_rad);_mouseVector.x=_mvx*_cos-_mvy*_sin;_mouseVector.y=_mvx*_sin+_mvy*_cos;var _f=_mouseVector.x;_._aw=(_f*2)/(_._M*(_._R-_._r));_._w+=_._aw;var _cueCard={x:_core.left,y:_core.top};_._vector.x=_cueCard.x-_._preCard.x;_._vector.y=_cueCard.y-_._preCard.y;_._preCard.x=_cueCard.x;_._preCard.y=_cueCard.y;_.x=_curMouse.x;_.y=_curMouse.y;}_._w*=_._friction;_._vector.x*=_._friction;_._vector.y*=_._friction;_._rotation-=_._w;if(!_._isPress){_.x+=_._vector.x;_.y+=_._vector.y;}_._preMouse.x=_curMouse.x;_._preMouse.y=_curMouse.y;_._zoneCheck();_._update();},_update:function(){var _degree=this._rotation/Math.PI*180;var _prop={};_prop.top=this.y;_prop.left=this.x;_prop['-moz-transform']='rotate('+_degree+'deg)';_prop['-webkit-transform']='rotate('+_degree+'deg)';_prop['-o-transform']='rotate('+_degree+'deg)';_prop['-ms-transform']='rotate('+_degree+'deg)';$(this.view).css(_prop);},_zoneCheck:function(){var $window=$(window);var _=this;var _w=$window.width();var _h=$window.height();if(_.x<0){_.x=0;_._vector.x*=-1;}else if(_.x>_w){_.x=_w;_._vector.x*=-1;}if(_.y<0){_.y=0;_._vector.y*=-1;}else if(_.y>_h){_.y=_h;_._vector.y*=-1;}},_doubleClick:function(){console.log('消したよ');var _this=this;$(this.view).animate({'opacity':0},400,function(){_this.kill();});},kill:function(){console.log('killcard');clearInterval(this.intervalKey);$(this.view).remove();}};